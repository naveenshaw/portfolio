{"componentChunkName":"component---src-templates-blog-post-jsx","path":"/blog/2018-10-29-renovate-gitlab/","result":{"data":{"markdownRemark":{"html":"<p>“Gitlab application screengrab” by Pankaj Patel on Unsplash</p>\n<p>Keeping your dependencies up-to-date is something many of us are struggling with. Of course, we want the latest and greatest. We want the latest security fixes. But the time of a developer is better spent on something more useful than checking every day if there is an update to a dependency and if this update does not break the current build.</p>\n<h3>Automate the process</h3>\n<p>To fix this problem you could use an external service like <a href=\"https://greenkeeper.io/\">greenkeeper</a> or <a href=\"https://renovatebot.com/\">renovate</a>. But both are only working with GitHub at the time of writing, when you are using their provided service. In the case of renovate there is an alternative to using their service. They keep the <a href=\"https://github.com/renovatebot/renovate\">source code of renovate</a> open and allow everyone to set up a self-hosted renovate bot. This sounds like a great hassle. Rent a new server, setup renovate, link to GitLab, setup a cron-job or something like this to check continuously.</p>\n<h3><strong>Gitlab-CI to the rescue</strong></h3>\n<p><img src=\"https://cdn-images-1.medium.com/max/2542/1*P2aylb0tE7ODbUlND17oQQ.png\" alt=\"GitLab-CI Pipeline View\"><em>GitLab-CI Pipeline View</em></p>\n<p>The<a href=\"https://about.gitlab.com/product/continuous-integration/\"> CI part of GitLab</a> is my favorite feature. For every repository, which I create I instantly setup a .gitlab-ci.yml. Whenever I push something to any branch of the repository, the code will be tested, a docker container will be build, and the documentation will be deployed. By manually activating the deployment job the project will be deployed to a production server. This part of GitLab is really worth checking out.</p>\n<p>But now to the fun part. Let’s use GitLab-CI to check chosen repositories for outdated dependencies and create merge request to update them. All we need is to create a new repository with three files:</p>\n<p><strong>config.js</strong> for configuring renovate</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">    module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n     platform<span class=\"token operator\">:</span> ‘gitlab’<span class=\"token punctuation\">,</span>\n     endpoint<span class=\"token operator\">:</span> ‘https<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>gitlab<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>api<span class=\"token operator\">/</span>v4<span class=\"token operator\">/</span>'<span class=\"token punctuation\">,</span>\n     assignees<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>‘mikebarkmin’<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n     baseBranches<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>‘master’<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n     labels<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>‘renovate’<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n     <span class=\"token keyword\">extends</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>‘config<span class=\"token operator\">:</span>base’<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>repositories.txt</strong> for keeping track which repositories we want to check</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">    openpatch/ui-core\n    openpatch/template</code></pre></div>\n<p><strong>.gitlab-ci.yml</strong> the heart which runs renovate</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> docker<span class=\"token punctuation\">:</span>latest\n    \n    <span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> docker<span class=\"token punctuation\">:</span>dind\n    \n    <span class=\"token key atrule\">renovate</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">stage</span><span class=\"token punctuation\">:</span> build\n      <span class=\"token key atrule\">script</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> docker run <span class=\"token punctuation\">-</span>e GITLAB_TOKEN=\"$GITLAB_TOKEN\" <span class=\"token punctuation\">-</span>e GITHUB_TOKEN=\"$GITHUB_TOKEN\" <span class=\"token punctuation\">-</span>v $PWD/config.js<span class=\"token punctuation\">:</span>/usr/src/app/config.js renovate/renovate<span class=\"token punctuation\">:</span>13 $(cat repositories.txt <span class=\"token punctuation\">|</span> xargs)\n      <span class=\"token key atrule\">only</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> master</code></pre></div>\n<p>As you can see I am using two GitLab <a href=\"https://docs.gitlab.com/ce/ci/variables/README.html#secret-variables\">Secret CI Variables</a> which needs to be configured. GITLAB<em>TOKEN needs to be a [Personal Access Token](<a href=\"https://docs.gitlab.com/ce/user/profile/personal\">https://docs.gitlab.com/ce/user/profile/personal</a></em>access<em>tokens.html) with the scope api and GITHUB</em>TOKEN needs to be a <a href=\"https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line/#creating-a-token\">Personal Access Token</a> with the scope repos.</p>\n<p>Now everything is finished. When you run the pipeline renovate will check the repositories in repositories.txt and create merge request if a dependency needs to be updated.</p>\n<p><img src=\"https://cdn-images-1.medium.com/max/2554/1*kAJqSk45_mE2HISVcjvbSQ.png\" alt=\"Pipeline Schedule Overview\"><em>Pipeline Schedule Overview</em></p>\n<p>At last, we can create a <a href=\"https://gitlab.com/help/user/project/pipelines/schedules\">Pipeline Schedule</a> to run the pipeline every x hours or x day or whatever you like.</p>\n<h3>Summary</h3>\n<p><img src=\"https://cdn-images-1.medium.com/max/2524/1*NVewoZL3fkvwljmuFz25Aw.png\" alt=\"Merge Request by Renovate\"><em>Merge Request by Renovate</em></p>\n<p>We have created a way to automate the dependency updating with GitLab-CI. We now just have to keep waiting for the merge requests and see if our test suites are successful. Afterwards we can happily merge (Assuming that your test suite is quite good). If you are really trusting your test suite, you can even let renovate auto-merge the request, if the pipeline succeeds. The last thing we could do is to create a separate user just for the renovate task. I hope you can now all optimize your workflow and never ever (OK most likely not ever) have to worry about updating your dependencies again.</p>","excerpt":"“Gitlab application screengrab” by Pankaj Patel on Unsplash Keeping your dependencies up-to-date is something many of us are struggling with…","frontmatter":{"title":"Renovate Your Gitlab Projects Automatically"}}},"pageContext":{"slug":"/blog/2018-10-29-renovate-gitlab/"}}}